<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Visor de Inventario Pro - Web App</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .input-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .input-section.active {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background-color: rgba(102, 126, 234, 0.05);
        }

        .form-control.field-completed {
            border-color: var(--success-color);
            background-color: rgba(39, 174, 96, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            border-left: 5px solid var(--primary-color);
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .pallet-info {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid var(--success-color);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-weight: bold;
            color: #155724;
            animation: pulse 2s infinite;
        }

        .pallet-not-found {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid var(--error-color);
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-weight: bold;
            color: #721c24;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            animation: slideIn 0.5s ease;
        }

        .status-success { 
            background: rgba(39, 174, 96, 0.1); 
            color: var(--success-color); 
            border-left: 4px solid var(--success-color); 
        }
        
        .status-warning { 
            background: rgba(243, 156, 18, 0.1); 
            color: var(--warning-color); 
            border-left: 4px solid var(--warning-color); 
        }
        
        .status-error { 
            background: rgba(231, 76, 60, 0.1); 
            color: var(--error-color); 
            border-left: 4px solid var(--error-color); 
        }
        
        .status-info { 
            background: rgba(52, 152, 219, 0.1); 
            color: var(--info-color); 
            border-left: 4px solid var(--info-color); 
        }

        .table-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-top: 25px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tr:hover {
            background-color: #f8f9fa;
        }

        .row-exacto { background-color: #d4edda !important; }
        .row-sobrante { background-color: #fff3cd !important; }
        .row-faltante { background-color: #f8d7da !important; }
        .row-no-encontrado { background-color: #e2e3e5 !important; }

        .keyboard-instructions {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border: 2px solid var(--success-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            color: #155724;
        }

        .duplicate-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .duplicate-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .processing-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .debug-console {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body>
    <!-- Processing Indicator -->
    <div id="processingIndicator" class="processing-indicator">
        <i class="fas fa-spinner fa-spin"></i> <span id="processingText">Procesando...</span>
    </div>

    <!-- Duplicate Modal -->
    <div id="duplicateModal" class="duplicate-modal">
        <div class="duplicate-content">
            <h3 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Pallet Duplicado Detectado</h3>
            <div id="duplicateInfo"></div>
            <div class="mt-4">
                <h5>¬øQu√© deseas hacer?</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-warning" onclick="handleDuplicate('replace')">
                        <i class="fas fa-sync"></i> Reemplazar anterior
                    </button>
                    <button class="btn btn-success" onclick="handleDuplicate('add')">
                        <i class="fas fa-plus"></i> A√±adir como nuevo
                    </button>
                    <button class="btn btn-secondary" onclick="handleDuplicate('cancel')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-boxes"></i> Visor de Inventario Pro</h1>
            <p class="mb-0">Aplicaci√≥n Web - Digitaci√≥n Ultra-R√°pida</p>
            <small>‚ö° Optimizado para archivos grandes (12,000+ filas)</small>
        </div>

        <!-- Debug Console -->
        <div class="debug-console" id="debugConsole">
            <strong>üîç Debug Console:</strong><br>
            <div id="debugMessages"></div>
        </div>
        <div class="text-center mb-3">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleDebug()">
                <i class="fas fa-bug"></i> Mostrar/Ocultar Debug
            </button>
        </div>

        <!-- File Upload Section -->
        <div class="input-section" id="uploadSection">
            <h3 class="text-center mb-4"><i class="fas fa-upload"></i> Cargar Archivo de Inventario</h3>
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <input type="file" class="form-control mb-3" id="inventoryFile" accept=".xlsx,.xls" required onchange="showFileInfo()">
                    <div id="fileInfo" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle"></i> <span id="fileDetails"></span>
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary btn-lg" onclick="loadInventory()" id="loadButton">
                            <i class="fas fa-cloud-upload-alt"></i> Cargar Inventario
                        </button>
                    </div>
                    <div class="text-muted text-center mt-2">
                        <small><i class="fas fa-info-circle"></i> Optimizado para archivos grandes (hasta 50MB / 50,000+ filas)</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div id="statsSection" class="row mb-4" style="display: none;">
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value" id="totalCount">0</div>
                    <div class="text-muted">Total</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value text-success" id="exactCount">0</div>
                    <div class="text-muted">Exactos</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value text-warning" id="overCount">0</div>
                    <div class="text-muted">Sobrantes</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value text-danger" id="underCount">0</div>
                    <div class="text-muted">Faltantes</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value text-info" id="notFoundCount">0</div>
                    <div class="text-muted">No Encontrados</div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="metric-card">
                    <div class="metric-value" id="precisionPercent">0%</div>
                    <div class="text-muted">Precisi√≥n</div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="chartsSection" class="charts-section" style="display: none;">
            <div class="chart-card">
                <h4 class="text-center mb-3"><i class="fas fa-chart-pie"></i> Distribuci√≥n de Resultados</h4>
                <canvas id="distributionChart"></canvas>
            </div>
            <div class="chart-card">
                <h4 class="text-center mb-3"><i class="fas fa-chart-bar"></i> An√°lisis por Almac√©n</h4>
                <canvas id="warehouseChart"></canvas>
            </div>
        </div>

        <!-- Input Section -->
        <div id="inputSection" class="input-section active" style="display: none;">
            <h3 class="text-center mb-4"><i class="fas fa-keyboard"></i> Digitaci√≥n Ultra-R√°pida</h3>
            
            <div class="keyboard-instructions">
                <i class="fas fa-bolt"></i>
                <strong>üöÄ Navegaci√≥n Perfecta:</strong><br>
                1Ô∏è‚É£ <strong>Tablilla</strong> ‚Üí <kbd>Enter</kbd> ‚Üí 2Ô∏è‚É£ <strong>ID Pallet</strong> ‚Üí <kbd>Enter</kbd> ‚Üí 3Ô∏è‚É£ <strong>Cantidad</strong> ‚Üí <kbd>Enter</kbd> (agregar autom√°ticamente)<br>
                <small>üí° La informaci√≥n del pallet aparece autom√°ticamente | Auto-focus despu√©s de agregar</small>
            </div>

            <form id="palletForm" onsubmit="return false;">
                <div class="row">
                    <div class="col-md-2">
                        <label for="numeroTablilla" class="form-label fw-bold">üìã Tablilla</label>
                        <input type="text" class="form-control" id="numeroTablilla" placeholder="001" data-field-index="0" required>
                    </div>
                    <div class="col-md-4">
                        <label for="idPallet" class="form-label fw-bold">üè∑Ô∏è ID Pallet</label>
                        <input type="text" class="form-control" id="idPallet" placeholder="PLT001" data-field-index="1" required>
                    </div>
                    <div class="col-md-2">
                        <label for="cantidadContada" class="form-label fw-bold">üìä Cantidad</label>
                        <input type="number" class="form-control" id="cantidadContada" min="0" placeholder="0" data-field-index="2" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100" id="addButton" onclick="addPallet()">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">&nbsp;</label>
                        <button type="button" class="btn btn-outline-danger w-100" onclick="clearAll()">
                            <i class="fas fa-trash"></i> Limpiar Todo
                        </button>
                    </div>
                </div>
            </form>

            <!-- Pallet Info Display -->
            <div id="palletInfo" class="mt-3"></div>
            
            <!-- Status Messages -->
            <div id="statusMessages" class="mt-3"></div>
        </div>

        <!-- Results Table -->
        <div id="resultsSection" class="table-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-table"></i> Resultados del Conteo</h3>
                <div>
                    <button class="btn btn-success me-2" onclick="exportToExcel()">
                        <i class="fas fa-download"></i> Descargar Excel
                    </button>
                    <button class="btn btn-info" onclick="toggleCharts()">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </button>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <input type="text" class="form-control" id="searchInput" placeholder="üîç Buscar en resultados..." onkeyup="filterTable()">
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="statusFilter" onchange="filterTable()">
                        <option value="">Todos los estados</option>
                        <option value="exacto">Exactos</option>
                        <option value="sobrante">Sobrantes</option>
                        <option value="faltante">Faltantes</option>
                        <option value="no-encontrado">No encontrados</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-outline-primary w-100" onclick="editSelected()">
                        <i class="fas fa-edit"></i> Editar Seleccionado
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped data-table" id="resultsTable">
                    <thead>
                        <tr>
                            <th>Sel</th>
                            <th>Tablilla</th>
                            <th>ID Pallet</th>
                            <th>Almac√©n</th>
                            <th>C√≥digo</th>
                            <th>Producto</th>
                            <th>Contado</th>
                            <th>Sistema</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        let inventoryData = [];
        let countedData = [];
        let inventoryIndex = {};
        let debugMode = false;

        // Funci√≥n de debug
        function debugLog(message) {
            console.log(message);
            if (debugMode) {
                const debugDiv = document.getElementById('debugMessages');
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugConsole').style.display = debugMode ? 'block' : 'none';
        }

        // Clase principal de la aplicaci√≥n
        class InventoryApp {
            constructor() {
                debugLog('üöÄ Inicializando aplicaci√≥n...');
                this.initializeKeyboardNavigation();
                this.initializeCharts();
                this.showProcessing(false);
                debugLog('‚úÖ Aplicaci√≥n inicializada');
            }

            // Sistema de navegaci√≥n por teclado PERFECTO
            initializeKeyboardNavigation() {
                debugLog('‚å®Ô∏è Configurando navegaci√≥n por teclado...');
                const fields = document.querySelectorAll('[data-field-index]');
                debugLog(`üìù Encontrados ${fields.length} campos de entrada`);
                
                fields.forEach((field, index) => {
                    field.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            debugLog(`‚èé Enter presionado en campo ${index}`);
                            
                            if (index === fields.length - 1) {
                                // √öltimo campo - agregar autom√°ticamente
                                debugLog('‚ûï √öltimo campo - agregando autom√°ticamente');
                                this.addPallet();
                            } else {
                                // Ir al siguiente campo
                                const nextField = fields[index + 1];
                                if (nextField) {
                                    nextField.focus();
                                    nextField.select();
                                    debugLog(`üéØ Navegando al campo ${index + 1}`);
                                }
                            }
                        }
                    });

                    field.addEventListener('input', (e) => {
                        // Marcar campo como completado
                        if (e.target.value.trim()) {
                            e.target.classList.add('field-completed');
                        } else {
                            e.target.classList.remove('field-completed');
                        }

                        // Auto-b√∫squeda para ID Pallet
                        if (index === 1 && e.target.value.trim()) {
                            debugLog(`üîç Buscando pallet: ${e.target.value}`);
                            this.searchPalletInfo(e.target.value.trim());
                        }
                    });
                });

                debugLog('‚úÖ Sistema de navegaci√≥n configurado');
            }

            // Cargar archivo de inventario - ROBUSTO para archivos grandes
            async loadInventory() {
                debugLog('üìÅ Iniciando carga de inventario...');
                
                const fileInput = document.getElementById('inventoryFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Por favor selecciona un archivo');
                    debugLog('‚ùå No se seleccion√≥ archivo');
                    return;
                }

                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                debugLog(`üìä Archivo: ${file.name} (${fileSizeMB} MB)`);
                
                if (file.size > 50 * 1024 * 1024) {
                    alert(`Archivo muy grande (${fileSizeMB} MB). El l√≠mite es 50MB.`);
                    debugLog(`‚ùå Archivo muy grande: ${fileSizeMB} MB`);
                    return;
                }

                this.showProcessing(true, 'Iniciando procesamiento...');

                try {
                    // Paso 1: Leer archivo
                    debugLog('üîÑ Paso 1: Leyendo archivo...');
                    this.updateProcessingText('Leyendo archivo...');
                    
                    const data = await file.arrayBuffer();
                    debugLog(`üìä Archivo le√≠do: ${data.byteLength} bytes`);
                    
                    // Paso 2: Parsear Excel
                    debugLog('üîÑ Paso 2: Parseando Excel...');
                    this.updateProcessingText('Parseando Excel...');
                    
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: false,
                        cellNF: false,
                        cellStyles: false,
                        sheetStubs: false
                    });
                    
                    debugLog(`üìã Hojas encontradas: ${workbook.SheetNames.join(', ')}`);
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Paso 3: Convertir a JSON
                    debugLog('üîÑ Paso 3: Convirtiendo a JSON...');
                    this.updateProcessingText('Convirtiendo datos...');
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        raw: false,
                        defval: '',
                        blankrows: false
                    });

                    debugLog(`üìã ${jsonData.length} filas encontradas`);

                    // Validar columnas requeridas
                    if (jsonData.length === 0) {
                        throw new Error('El archivo est√° vac√≠o');
                    }

                    const firstRow = jsonData[0];
                    const availableCols = Object.keys(firstRow);
                    debugLog(`üìä Columnas disponibles: ${availableCols.join(', ')}`);
                    
                    const requiredCols = ['Id de pallet', 'Inventario f√≠sico'];
                    const missingCols = requiredCols.filter(col => !(col in firstRow));

                    if (missingCols.length > 0) {
                        throw new Error(`Faltan columnas requeridas: ${missingCols.join(', ')}\nColumnas disponibles: ${availableCols.join(', ')}`);
                    }

                    // Paso 4: Procesar datos en chunks
                    debugLog('üîÑ Paso 4: Procesando datos en chunks...');
                    inventoryData = [];
                    inventoryIndex = {};
                    const chunkSize = 500; // Reducir chunk size para mejor responsividad
                    
                    for (let i = 0; i < jsonData.length; i += chunkSize) {
                        const chunk = jsonData.slice(i, i + chunkSize);
                        const progress = Math.round((i / jsonData.length) * 100);
                        
                        debugLog(`üìä Procesando chunk ${Math.floor(i/chunkSize) + 1}/${Math.ceil(jsonData.length/chunkSize)} (${progress}%)`);
                        this.updateProcessingText(`Procesando: ${progress}% (${i}/${jsonData.length})`);
                        
                        const processedChunk = chunk.map((row, chunkIndex) => {
                            const item = {
                                id: String(row['Id de pallet'] || '').trim(),
                                quantity: parseInt(row['Inventario f√≠sico']) || 0,
                                warehouse: String(row['Almac√©n'] || 'Almac√©n General').trim(),
                                code: String(row['C√≥digo de art√≠culo'] || 'N/A').trim(),
                                name: String(row['Nombre del producto'] || 'Producto sin nombre').trim()
                            };
                            
                            // Crear √≠ndice para b√∫squedas r√°pidas
                            if (item.id) {
                                inventoryIndex[item.id.toLowerCase()] = inventoryData.length + chunkIndex;
                            }
                            
                            return item;
                        });
                        
                        inventoryData = inventoryData.concat(processedChunk);
                        
                        // Permitir que la UI se actualice
                        await new Promise(resolve => setTimeout(resolve, 5));
                    }

                    // Paso 5: Finalizar
                    debugLog('üîÑ Paso 5: Finalizando...');
                    this.updateProcessingText('Finalizando...');

                    const duplicates = this.findDuplicates(inventoryData.map(item => item.id));
                    debugLog(`üìä Estad√≠sticas: ${inventoryData.length} registros, ${duplicates} duplicados`);
                    
                    this.showMessage(`‚úÖ Inventario cargado exitosamente: ${inventoryData.length.toLocaleString()} registros${duplicates > 0 ? ` (${duplicates} duplicados detectados)` : ''}`, 'success');
                    
                    // Mostrar secciones
                    document.getElementById('uploadSection').style.display = 'none';
                    document.getElementById('statsSection').style.display = 'block';
                    document.getElementById('inputSection').style.display = 'block';
                    
                    // Auto-focus en primer campo
                    setTimeout(() => {
                        document.getElementById('numeroTablilla').focus();
                        debugLog('üéØ Auto-focus activado - listo para digitaci√≥n');
                    }, 100);

                } catch (error) {
                    debugLog(`‚ùå Error: ${error.message}`);
                    console.error('Error completo:', error);
                    this.showMessage(`‚ùå Error cargando archivo: ${error.message}`, 'error');
                    
                    // Mostrar detalles t√©cnicos en debug
                    if (debugMode) {
                        debugLog(`üîç Stack trace: ${error.stack}`);
                    }
                } finally {
                    this.showProcessing(false);
                    debugLog('üèÅ Proceso de carga finalizado');
                }
            }

            // Buscar informaci√≥n del pallet - OPTIMIZADO
            searchPalletInfo(palletId) {
                const infoDiv = document.getElementById('palletInfo');
                
                if (!palletId.trim()) {
                    infoDiv.innerHTML = '';
                    return;
                }
                
                debugLog(`üîç Buscando pallet: ${palletId}`);
                
                // B√∫squeda ultra-r√°pida usando √≠ndice
                const index = inventoryIndex[palletId.toLowerCase()];
                const info = index !== undefined ? inventoryData[index] : null;
                
                if (info) {
                    debugLog(`‚úÖ Pallet encontrado: ${info.warehouse} | ${info.code} | ${info.name}`);
                    infoDiv.innerHTML = `
                        <div class="pallet-info">
                            <i class="fas fa-check-circle"></i>
                            <strong>‚úÖ Detectado:</strong> ${info.warehouse} | ${info.code} | 
                            ${info.name.substring(0, 40)}${info.name.length > 40 ? '...' : ''} | 
                            Sistema: <strong>${info.quantity}</strong>
                        </div>
                    `;
                } else {
                    debugLog(`‚ùå Pallet no encontrado: ${palletId}`);
                    infoDiv.innerHTML = `
                        <div class="pallet-not-found">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>‚ö†Ô∏è Pallet no encontrado en el sistema</strong>
                        </div>
                    `;
                }
            }

            // Agregar pallet
            addPallet() {
                debugLog('‚ûï Intentando agregar pallet...');
                
                const tablilla = document.getElementById('numeroTablilla').value.trim();
                const palletId = document.getElementById('idPallet').value.trim();
                const quantity = parseInt(document.getElementById('cantidadContada').value) || 0;

                debugLog(`üìä Datos: Tablilla=${tablilla}, ID=${palletId}, Cantidad=${quantity}`);

                if (!tablilla || !palletId) {
                    this.showMessage('‚ùå Por favor completa Tablilla e ID de Pallet', 'error');
                    debugLog('‚ùå Campos incompletos');
                    return;
                }

                // Verificar duplicados
                const existingIndex = countedData.findIndex(item => item.palletId === palletId);
                
                if (existingIndex !== -1) {
                    debugLog(`‚ö†Ô∏è Duplicado detectado en √≠ndice ${existingIndex}`);
                    this.showDuplicateModal(tablilla, palletId, quantity, existingIndex);
                    return;
                }

                // Procesar pallet
                debugLog('‚úÖ Procesando pallet...');
                this.processPallet(tablilla, palletId, quantity);
            }

            // Procesar pallet
            processPallet(tablilla, palletId, quantity, replaceIndex = -1) {
                debugLog(`üîÑ Procesando: ${palletId} (cantidad: ${quantity})`);
                
                // B√∫squeda ultra-r√°pida usando √≠ndice
                const index = inventoryIndex[palletId.toLowerCase()];
                const inventoryInfo = index !== undefined ? inventoryData[index] : null;
                
                const newItem = {
                    tablilla: tablilla,
                    palletId: palletId,
                    warehouse: inventoryInfo ? inventoryInfo.warehouse : 'N/A',
                    code: inventoryInfo ? inventoryInfo.code : 'N/A',
                    name: inventoryInfo ? inventoryInfo.name : 'N/A',
                    countedQuantity: quantity,
                    systemQuantity: inventoryInfo ? inventoryInfo.quantity : null,
                    difference: quantity - (inventoryInfo ? inventoryInfo.quantity : 0),
                    timestamp: new Date()
                };

                if (replaceIndex >= 0) {
                    countedData[replaceIndex] = newItem;
                    debugLog(`üîÑ Pallet reemplazado en √≠ndice ${replaceIndex}`);
                    this.showMessage(`üîÑ Pallet ${palletId} reemplazado`, 'warning');
                } else {
                    countedData.push(newItem);
                    debugLog(`‚ûï Pallet agregado (total: ${countedData.length})`);
                }

                // Feedback visual
                if (inventoryInfo) {
                    if (newItem.difference === 0) {
                        this.showMessage(`‚úÖ ${palletId}: Cantidad exacta (${quantity}) - ${inventoryInfo.name.substring(0, 30)}`, 'success');
                    } else if (newItem.difference > 0) {
                        this.showMessage(`üîº ${palletId}: Sobrante de ${newItem.difference} unidades - ${inventoryInfo.name.substring(0, 30)}`, 'warning');
                    } else {
                        this.showMessage(`üîΩ ${palletId}: Faltante de ${Math.abs(newItem.difference)} unidades - ${inventoryInfo.name.substring(0, 30)}`, 'error');
                    }
                } else {
                    this.showMessage(`‚ùì ${palletId}: No encontrado en sistema - ${quantity} unidades`, 'info');
                }

                this.clearForm();
                this.updateStats();
                this.updateTable();
                this.updateCharts();
                
                debugLog('‚úÖ Pallet procesado completamente');
            }

            // Modal de duplicados
            showDuplicateModal(tablilla, palletId, quantity, existingIndex) {
                debugLog(`‚ö†Ô∏è Mostrando modal de duplicado para ${palletId}`);
                
                const modal = document.getElementById('duplicateModal');
                const info = document.getElementById('duplicateInfo');
                
                const existingItem = countedData[existingIndex];
                info.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>Pallet:</strong> ${palletId}<br>
                        <strong>Cantidad anterior:</strong> ${existingItem.countedQuantity}<br>
                        <strong>Cantidad nueva:</strong> ${quantity}
                    </div>
                `;
                
                modal.style.display = 'flex';
                
                // Guardar datos temporales
                window.tempDuplicateData = { tablilla, palletId, quantity, existingIndex };
            }

            // Limpiar formulario y auto-focus
            clearForm() {
                debugLog('üßπ Limpiando formulario...');
                
                document.getElementById('palletForm').reset();
                document.getElementById('palletInfo').innerHTML = '';
                
                // Remover clases de completado
                document.querySelectorAll('.form-control').forEach(field => {
                    field.classList.remove('field-completed');
                });
                
                // Auto-focus en primer campo
                setTimeout(() => {
                    document.getElementById('numeroTablilla').focus();
                    document.getElementById('numeroTablilla').select();
                    debugLog('üéØ Auto-focus activado');
                }, 100);
            }

            // Actualizar estad√≠sticas
            updateStats() {
                const total = countedData.length;
                const exact = countedData.filter(item => item.difference === 0).length;
                const over = countedData.filter(item => item.difference > 0).length;
                const under = countedData.filter(item => item.difference < 0).length;
                const notFound = countedData.filter(item => item.systemQuantity === null).length;
                const precision = total > 0 ? ((exact / total) * 100).toFixed(1) : 0;

                document.getElementById('totalCount').textContent = total;
                document.getElementById('exactCount').textContent = exact;
                document.getElementById('overCount').textContent = over;
                document.getElementById('underCount').textContent = under;
                document.getElementById('notFoundCount').textContent = notFound;
                document.getElementById('precisionPercent').textContent = precision + '%';
                
                debugLog(`üìä Stats: Total=${total}, Exactos=${exact}, Precisi√≥n=${precision}%`);
            }

            // Actualizar tabla
            updateTable() {
                debugLog('üìã Actualizando tabla...');
                
                const tbody = document.getElementById('resultsTableBody');
                tbody.innerHTML = '';

                countedData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    
                    let statusClass = '';
                    let statusText = '';
                    
                    if (item.systemQuantity === null) {
                        statusClass = 'row-no-encontrado';
                        statusText = '‚ùì No encontrado';
                    } else if (item.difference === 0) {
                        statusClass = 'row-exacto';
                        statusText = '‚úÖ Exacto';
                    } else if (item.difference > 0) {
                        statusClass = 'row-sobrante';
                        statusText = `üîº +${item.difference}`;
                    } else {
                        statusClass = 'row-faltante';
                        statusText = `üîΩ ${item.difference}`;
                    }

                    row.className = statusClass;
                    row.innerHTML = `
                        <td><input type="checkbox" class="form-check-input" data-index="${index}"></td>
                        <td>${item.tablilla}</td>
                        <td><strong>${item.palletId}</strong></td>
                        <td>${item.warehouse}</td>
                        <td>${item.code}</td>
                        <td>${item.name.substring(0, 30)}${item.name.length > 30 ? '...' : ''}</td>
                        <td class="text-center"><strong>${item.countedQuantity}</strong></td>
                        <td class="text-center">${item.systemQuantity !== null ? item.systemQuantity : 'N/A'}</td>
                        <td class="text-center"><strong>${statusText}</strong></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem(${index})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });

                // Mostrar secci√≥n de resultados si hay datos
                document.getElementById('resultsSection').style.display = countedData.length > 0 ? 'block' : 'none';
                debugLog(`üìã Tabla actualizada con ${countedData.length} registros`);
            }

            // Inicializar gr√°ficos
            initializeCharts() {
                debugLog('üìà Inicializando gr√°ficos...');
                
                try {
                    // Gr√°fico de distribuci√≥n
                    const ctx1 = document.getElementById('distributionChart').getContext('2d');
                    window.distributionChart = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['Exactos', 'Sobrantes', 'Faltantes', 'No Encontrados'],
                            datasets: [{
                                data: [0, 0, 0, 0],
                                backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#9b59b6'],
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Gr√°fico por almac√©n
                    const ctx2 = document.getElementById('warehouseChart').getContext('2d');
                    window.warehouseChart = new Chart(ctx2, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Pallets por Almac√©n',
                                data: [],
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: 'rgba(102, 126, 234, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    debugLog('‚úÖ Gr√°ficos inicializados');
                } catch (error) {
                    debugLog(`‚ùå Error inicializando gr√°ficos: ${error.message}`);
                }
            }

            // Actualizar gr√°ficos
            updateCharts() {
                if (countedData.length === 0) return;

                try {
                    debugLog('üìà Actualizando gr√°ficos...');
                    
                    // Actualizar gr√°fico de distribuci√≥n
                    const exact = countedData.filter(item => item.difference === 0).length;
                    const over = countedData.filter(item => item.difference > 0).length;
                    const under = countedData.filter(item => item.difference < 0).length;
                    const notFound = countedData.filter(item => item.systemQuantity === null).length;

                    window.distributionChart.data.datasets[0].data = [exact, over, under, notFound];
                    window.distributionChart.update();

                    // Actualizar gr√°fico por almac√©n
                    const warehouseCounts = {};
                    countedData.forEach(item => {
                        warehouseCounts[item.warehouse] = (warehouseCounts[item.warehouse] || 0) + 1;
                    });

                    window.warehouseChart.data.labels = Object.keys(warehouseCounts);
                    window.warehouseChart.data.datasets[0].data = Object.values(warehouseCounts);
                    window.warehouseChart.update();

                    // Mostrar secci√≥n de gr√°ficos
                    document.getElementById('chartsSection').style.display = 'block';
                    debugLog('‚úÖ Gr√°ficos actualizados');
                } catch (error) {
                    debugLog(`‚ùå Error actualizando gr√°ficos: ${error.message}`);
                }
            }

            // Mostrar mensaje
            showMessage(message, type) {
                const messagesDiv = document.getElementById('statusMessages');
                const messageEl = document.createElement('div');
                messageEl.className = `status-message status-${type}`;
                messageEl.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
                
                messagesDiv.appendChild(messageEl);
                
                // Remover despu√©s de 5 segundos
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 5000);
            }

            // Mostrar indicador de procesamiento
            showProcessing(show, text = 'Procesando...') {
                const indicator = document.getElementById('processingIndicator');
                indicator.style.display = show ? 'block' : 'none';
                
                if (show) {
                    this.updateProcessingText(text);
                }
            }
            
            updateProcessingText(text) {
                document.getElementById('processingText').textContent = text;
            }

            // Encontrar duplicados
            findDuplicates(arr) {
                return arr.length - new Set(arr).size;
            }

            // Exportar a Excel
            exportToExcel() {
                debugLog('üìä Iniciando exportaci√≥n a Excel...');
                
                if (countedData.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                try {
                    const wb = XLSX.utils.book_new();
                    
                    // Hoja de resumen
                    const summary = [
                        ['M√©trica', 'Valor'],
                        ['Fecha del Reporte', new Date().toLocaleString()],
                        ['Total Pallets Digitados', countedData.length],
                        ['Pallets Exactos', countedData.filter(item => item.difference === 0).length],
                        ['Pallets Sobrantes', countedData.filter(item => item.difference > 0).length],
                        ['Pallets Faltantes', countedData.filter(item => item.difference < 0).length],
                        ['Pallets No Encontrados', countedData.filter(item => item.systemQuantity === null).length]
                    ];
                    
                    const summaryWs = XLSX.utils.aoa_to_sheet(summary);
                    XLSX.utils.book_append_sheet(wb, summaryWs, 'Resumen');

                    // Hoja de datos completos
                    const fullData = countedData.map(item => ({
                        'Tablilla': item.tablilla,
                        'ID Pallet': item.palletId,
                        'Almac√©n': item.warehouse,
                        'C√≥digo': item.code,
                        'Producto': item.name,
                        'Cantidad Contada': item.countedQuantity,
                        'Inventario Sistema': item.systemQuantity,
                        'Diferencia': item.difference
                    }));
                    
                    const dataWs = XLSX.utils.json_to_sheet(fullData);
                    XLSX.utils.book_append_sheet(wb, dataWs, 'Datos Completos');

                    // Hoja de discrepancias
                    const discrepancies = countedData.filter(item => item.difference !== 0);
                    if (discrepancies.length > 0) {
                        const discWs = XLSX.utils.json_to_sheet(discrepancies.map(item => ({
                            'Tablilla': item.tablilla,
                            'ID Pallet': item.palletId,
                            'Almac√©n': item.warehouse,
                            'C√≥digo': item.code,
                            'Producto': item.name,
                            'Cantidad Contada': item.countedQuantity,
                            'Inventario Sistema': item.systemQuantity,
                            'Diferencia': item.difference
                        })));
                        XLSX.utils.book_append_sheet(wb, discWs, 'Discrepancias');
                    }

                    // Descargar archivo
                    const fileName = `Inventario_Pro_${new Date().toISOString().slice(0, 19).replace(/[:-]/g, '')}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                    
                    this.showMessage('üìä Reporte Excel generado y descargado', 'success');
                    debugLog(`‚úÖ Excel exportado: ${fileName}`);
                } catch (error) {
                    debugLog(`‚ùå Error exportando Excel: ${error.message}`);
                    this.showMessage(`‚ùå Error exportando: ${error.message}`, 'error');
                }
            }
        }

        // Instancia global de la aplicaci√≥n
        let app;

        // Funciones globales con manejo de errores robusto
        function showFileInfo() {
            try {
                const fileInput = document.getElementById('inventoryFile');
                const file = fileInput.files[0];
                
                if (file) {
                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    const fileInfo = document.getElementById('fileInfo');
                    const fileDetails = document.getElementById('fileDetails');
                    
                    debugLog(`üìÅ Archivo seleccionado: ${file.name} (${fileSizeMB} MB)`);
                    
                    if (file.size > 50 * 1024 * 1024) {
                        fileInfo.className = 'alert alert-danger';
                        fileDetails.innerHTML = `<strong>‚ùå Archivo muy grande:</strong> ${file.name} (${fileSizeMB} MB) - L√≠mite: 50MB`;
                        document.getElementById('loadButton').disabled = true;
                    } else if (file.size > 10 * 1024 * 1024) {
                        fileInfo.className = 'alert alert-warning';
                        fileDetails.innerHTML = `<strong>‚ö†Ô∏è Archivo grande:</strong> ${file.name} (${fileSizeMB} MB) - Procesamiento optimizado`;
                        document.getElementById('loadButton').disabled = false;
                    } else {
                        fileInfo.className = 'alert alert-success';
                        fileDetails.innerHTML = `<strong>‚úÖ Archivo:</strong> ${file.name} (${fileSizeMB} MB) - Listo para procesar`;
                        document.getElementById('loadButton').disabled = false;
                    }
                    
                    fileInfo.style.display = 'block';
                }
            } catch (error) {
                debugLog(`‚ùå Error mostrando info de archivo: ${error.message}`);
            }
        }

        function loadInventory() {
            try {
                debugLog('üöÄ Funci√≥n loadInventory llamada');
                if (app) {
                    app.loadInventory();
                } else {
                    debugLog('‚ùå App no inicializada');
                    alert('Error: Aplicaci√≥n no inicializada. Recarga la p√°gina.');
                }
            } catch (error) {
                debugLog(`‚ùå Error en loadInventory: ${error.message}`);
                alert(`Error: ${error.message}`);
            }
        }

        function addPallet() {
            try {
                if (app) {
                    app.addPallet();
                } else {
                    alert('Error: Aplicaci√≥n no inicializada');
                }
            } catch (error) {
                debugLog(`‚ùå Error agregando pallet: ${error.message}`);
                alert(`Error: ${error.message}`);
            }
        }

        function handleDuplicate(action) {
            try {
                const modal = document.getElementById('duplicateModal');
                const data = window.tempDuplicateData;
                
                if (action === 'replace') {
                    app.processPallet(data.tablilla, data.palletId, data.quantity, data.existingIndex);
                } else if (action === 'add') {
                    app.processPallet(data.tablilla, data.palletId, data.quantity);
                }
                
                modal.style.display = 'none';
                delete window.tempDuplicateData;
            } catch (error) {
                debugLog(`‚ùå Error manejando duplicado: ${error.message}`);
            }
        }

        function clearAll() {
            try {
                if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos?')) {
                    countedData = [];
                    app.updateStats();
                    app.updateTable();
                    app.updateCharts();
                    document.getElementById('chartsSection').style.display = 'none';
                    app.showMessage('üóëÔ∏è Todos los datos han sido limpiados', 'info');
                    debugLog('üóëÔ∏è Datos limpiados');
                }
            } catch (error) {
                debugLog(`‚ùå Error limpiando datos: ${error.message}`);
            }
        }

        function exportToExcel() {
            try {
                app.exportToExcel();
            } catch (error) {
                debugLog(`‚ùå Error exportando: ${error.message}`);
            }
        }

        function toggleCharts() {
            try {
                const chartsSection = document.getElementById('chartsSection');
                const isVisible = chartsSection.style.display !== 'none';
                chartsSection.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    app.updateCharts();
                }
            } catch (error) {
                debugLog(`‚ùå Error toggling charts: ${error.message}`);
            }
        }

        function filterTable() {
            try {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const rows = document.querySelectorAll('#resultsTableBody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const matchesSearch = text.includes(searchTerm);
                    
                    let matchesStatus = true;
                    if (statusFilter) {
                        matchesStatus = row.classList.contains(`row-${statusFilter}`);
                    }

                    row.style.display = matchesSearch && matchesStatus ? '' : 'none';
                });
            } catch (error) {
                debugLog(`‚ùå Error filtrando tabla: ${error.message}`);
            }
        }

        function editItem(index) {
            try {
                const item = countedData[index];
                const newQuantity = prompt(`Editar cantidad para ${item.palletId}:`, item.countedQuantity);
                
                if (newQuantity !== null && !isNaN(newQuantity)) {
                    const quantity = parseInt(newQuantity);
                    const inventoryInfo = inventoryData.find(inv => inv.id.toLowerCase() === item.palletId.toLowerCase());
                    
                    item.countedQuantity = quantity;
                    item.difference = quantity - (inventoryInfo ? inventoryInfo.quantity : 0);
                    
                    app.updateStats();
                    app.updateTable();
                    app.updateCharts();
                    app.showMessage(`‚úèÔ∏è Pallet ${item.palletId} editado`, 'info');
                    debugLog(`‚úèÔ∏è Pallet editado: ${item.palletId}`);
                }
            } catch (error) {
                debugLog(`‚ùå Error editando item: ${error.message}`);
            }
        }

        function deleteItem(index) {
            try {
                if (confirm(`¬øEliminar el pallet ${countedData[index].palletId}?`)) {
                    const deletedId = countedData[index].palletId;
                    countedData.splice(index, 1);
                    
                    app.updateStats();
                    app.updateTable();
                    app.updateCharts();
                    app.showMessage(`üóëÔ∏è Pallet ${deletedId} eliminado`, 'info');
                    debugLog(`üóëÔ∏è Pallet eliminado: ${deletedId}`);
                }
            } catch (error) {
                debugLog(`‚ùå Error eliminando item: ${error.message}`);
            }
        }

        function editSelected() {
            try {
                const checkboxes = document.querySelectorAll('#resultsTableBody input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('Selecciona al menos un registro para editar');
                    return;
                }
                
                if (checkboxes.length > 1) {
                    alert('Selecciona solo un registro para editar');
                    return;
                }
                
                const index = parseInt(checkboxes[0].getAttribute('data-index'));
                editItem(index);
            } catch (error) {
                debugLog(`‚ùå Error editando seleccionado: ${error.message}`);
            }
        }

        // Inicializar aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            try {
                debugLog('üöÄ DOM cargado, inicializando aplicaci√≥n...');
                
                // Verificar dependencias
                if (typeof XLSX === 'undefined') {
                    debugLog('‚ùå SheetJS no cargado');
                    alert('Error: Librer√≠a Excel no cargada. Verifica tu conexi√≥n a internet.');
                    return;
                }
                
                if (typeof Chart === 'undefined') {
                    debugLog('‚ùå Chart.js no cargado');
                    alert('Error: Librer√≠a de gr√°ficos no cargada. Verifica tu conexi√≥n a internet.');
                    return;
                }
                
                debugLog('‚úÖ Dependencias verificadas');
                
                app = new InventoryApp();
                
                // Cerrar modal al hacer clic fuera
                document.getElementById('duplicateModal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
                
                debugLog('üéØ Aplicaci√≥n completamente inicializada');
                
                // Mostrar mensaje de bienvenida
                setTimeout(() => {
                    if (app) {
                        app.showMessage('üöÄ Aplicaci√≥n lista - Selecciona un archivo Excel para comenzar', 'info');
                    }
                }, 1000);
                
            } catch (error) {
                debugLog(`‚ùå Error cr√≠tico inicializando: ${error.message}`);
                console.error('Error completo:', error);
                alert(`Error cr√≠tico: ${error.message}\nRevisa la consola para m√°s detalles.`);
            }
        });

        // Manejo global de errores
        window.addEventListener('error', function(e) {
            debugLog(`‚ùå Error global: ${e.message} en ${e.filename}:${e.lineno}`);
            console.error('Error global:', e);
        });

        window.addEventListener('unhandledrejection', function(e) {
            debugLog(`‚ùå Promise rechazada: ${e.reason}`);
            console.error('Promise rejection:', e);
        });
    </script>
</body>
</html>